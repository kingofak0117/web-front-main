<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Data Groups | Devices Live</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* ===== COMPACT RESET ===== */
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --primary: #2563eb;
  --primary-light: #dbeafe;
  --primary-dark: #1d4ed8;
  --primary-gradient: linear-gradient(135deg, #2563eb, #3b82f6);
  
  --success: #10b981;
  --success-dark: #059669;
  --danger: #ef4444;
  --danger-dark: #dc2626;
  --warning: #f59e0b;
  
  --gray-50: #f9fafb;
  --gray-100: #f3f4f6;
  --gray-200: #e5e7eb;
  --gray-300: #d1d5db;
  --gray-400: #9ca3af;
  --gray-500: #6b7280;
  --gray-600: #4b5563;
  --gray-700: #374151;
  --gray-800: #1f2937;
  --gray-900: #111827;
  
  --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.2);
  
  --radius: 8px;
  --radius-sm: 6px;
  --radius-md: 8px;
  --radius-lg: 10px;
  
  --transition: all 0.2s ease;
  --transition-medium: all 0.3s ease;
}

body {
  font-family: 'Inter', sans-serif;
  background: var(--gray-50);
  color: var(--gray-800);
  min-height: 100vh;
  font-size: 14px;
  line-height: 1.5;
}

/* ===== COMPACT HEADER ===== */
.header {
  background: var(--primary-gradient);
  padding: 10px 16px;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: var(--shadow-md);
  border-bottom: 3px solid rgba(255, 255, 255, 0.2);
}

.header-inner {
  display: flex;
  justify-content: space-between;
  align-items: center;
  max-width: 1200px;
  margin: 0 auto;
}

.header-title {
  font-size: 15px;
  font-weight: 700;
  color: white;
  display: flex;
  align-items: center;
  gap: 10px;
  text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

.live-badge {
  background: linear-gradient(135deg, var(--danger), var(--danger-dark));
  color: white;
  padding: 5px 12px;
  border-radius: 16px;
  font-size: 13px;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  border: 2px solid rgba(255, 255, 255, 0.3);
  animation: pulse 2s infinite;
}

.total-pill {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.95);
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  background: rgba(255, 255, 255, 0.12);
  padding: 8px 14px;
  border-radius: var(--radius-md);
  backdrop-filter: blur(8px);
  border: 2px solid rgba(255, 255, 255, 0.25);
}

.total-number {
  font-weight: 700;
  color: white;
  font-size: 16px;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.02); }
}

/* ===== COMPACT NAVIGATION ===== */
.nav {
  background: white;
  border-bottom: 2px solid var(--gray-200);
  position: sticky;
  top: 52px;
  z-index: 99;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.04);
  padding: 6px 0;
}

.nav-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 16px;
}

.nav-links {
  display: flex;
  justify-content: center;
  gap: 8px;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
  padding: 4px 0;
}

.nav-links::-webkit-scrollbar {
  display: none;
}

.nav a {
  color: var(--gray-600);
  text-decoration: none;
  padding: 10px 16px;
  font-size: 13px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
  border-radius: var(--radius-md);
  white-space: nowrap;
  transition: var(--transition);
  border: 2px solid transparent;
  background: var(--gray-100);
}

.nav a:hover {
  background: var(--primary-light);
  color: var(--primary);
  transform: translateY(-2px);
  box-shadow: var(--shadow-sm);
}

.nav a.active {
  background: var(--primary-gradient);
  color: white;
  font-weight: 700;
  border-color: var(--primary-dark);
  box-shadow: 0 3px 10px rgba(37, 99, 235, 0.2);
  transform: translateY(-2px);
}

.nav a.active i {
  color: white;
}

.nav a i {
  font-size: 14px;
  color: var(--gray-600);
  transition: color var(--transition);
}

.nav a:hover i,
.nav a.active i {
  color: inherit;
}

/* ===== COMPACT SEARCH BAR ===== */
.search-bar {
  background: white;
  padding: 14px 16px;
  border-bottom: 2px solid var(--gray-200);
  margin-bottom: 14px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.03);
  position: sticky;
  top: 86px;
  z-index: 98;
}

.search-container {
  position: relative;
  max-width: 800px;
  margin: 0 auto;
}

.search-bar input {
  width: 100%;
  padding: 12px 14px 12px 40px;
  border-radius: var(--radius-lg);
  border: 2px solid var(--gray-300);
  font-size: 14px;
  background: var(--gray-50);
  transition: var(--transition-medium);
  font-weight: 500;
  color: var(--gray-800);
}

.search-bar input:focus {
  outline: none;
  border-color: var(--primary);
  background: white;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.12);
  transform: translateY(-1px);
}

.search-bar i {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--primary);
  font-size: 14px;
}

/* ===== MAIN CONTENT ===== */
.main-content {
  padding: 0 14px 25px;
  max-width: 1200px;
  margin: 0 auto;
}

.groups {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
  gap: 16px;
}

/* ===== DYNAMIC DATA CARD ===== */
.data-card {
  background: white;
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: var(--transition-medium);
  border: 2px solid var(--gray-200);
  box-shadow: var(--shadow-sm);
  position: relative;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  min-height: auto;
  height: auto;
}

.data-card:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow);
  border-color: var(--primary);
}

/* Blue strap at top */
.data-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 5px;
  background: var(--primary-gradient);
}

/* ===== CARD HEADER ===== */
.data-card-header-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 16px 10px;
  background: linear-gradient(to bottom, rgba(219, 234, 254, 0.15), transparent);
  min-height: 55px;
  flex-shrink: 0;
}

.card-header {
  font-size: 16px;
  font-weight: 700;
  color: var(--primary-dark);
  display: flex;
  align-items: center;
  gap: 8px;
  flex: 1;
  min-width: 0;
}

.card-header::before {
  content: '';
  width: 5px;
  height: 18px;
  background: var(--primary);
  border-radius: var(--radius-sm);
  display: inline-block;
  flex-shrink: 0;
}

.uid-text {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
  font-size: 15px;
  font-weight: 600;
}

.group-status-chip {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 6px 12px;
  border-radius: var(--radius-sm);
  border: 2px solid var(--primary);
  font-size: 13px;
  font-weight: 700;
  background: var(--primary-light);
  color: var(--primary-dark);
  min-width: 90px;
  text-align: center;
  flex-shrink: 0;
  white-space: nowrap;
}

/* ===== CARD CONTENT ===== */
.card-content {
  padding: 12px 16px;
  flex: 1;
  min-height: 0;
  overflow: visible;
}

/* ===== SECTION TITLE ===== */
.section-title {
  margin: 12px 0 8px;
  font-size: 14px;
  font-weight: 700;
  color: var(--primary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding-bottom: 6px;
  border-bottom: 2px solid var(--primary-light);
  display: flex;
  align-items: center;
  gap: 8px;
  position: sticky;
  top: 0;
  background: white;
  padding: 8px 4px;
}

.section-title::before {
  content: '';
  width: 4px;
  height: 14px;
  background: var(--primary);
  border-radius: var(--radius-sm);
  display: inline-block;
  flex-shrink: 0;
}

/* ===== DATA ITEM ===== */
.data-item {
  font-size: 13px;
  padding: 8px 0;
  border-bottom: 1px solid var(--gray-100);
  color: var(--gray-800);
  word-break: break-word;
  line-height: 1.5;
  display: flex;
  align-items: flex-start;
  gap: 10px;
}

.data-item:last-child {
  border-bottom: none;
}

.data-item b {
  color: var(--gray-600);
  font-weight: 600;
  min-width: 120px;
  flex-shrink: 0;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.data-item-value {
  flex: 1;
  min-width: 0;
  font-weight: 500;
  font-size: 13px;
  font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
}

/* ===== LOADER - COMPACT ===== */
.fullscreen-loader {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: white;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  transition: opacity 0.4s ease, visibility 0.4s ease;
}

.fullscreen-loader.hidden {
  opacity: 0;
  visibility: hidden;
}

.loader {
  position: relative;
  width: 70px;
  height: 70px;
  margin: 0 auto 16px;
}

.loader-inner {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  position: relative;
  animation: rotate 2s linear infinite;
}

.loader-ring {
  position: absolute;
  width: 100%;
  height: 100%;
  border-radius: 50%;
}

.loader-ring:nth-child(1) {
  border: 5px solid transparent;
  border-top: 5px solid rgb(0, 94, 255);
  border-right: 5px solid rgb(0, 94, 255);
  animation: spin1 1.5s ease-in-out infinite alternate;
}

.loader-ring:nth-child(2) {
  border: 4px solid transparent;
  border-bottom: 4px solid rgb(0, 94, 255);
  border-left: 4px solid rgb(0, 94, 255);
  top: 15%;
  left: 15%;
  width: 70%;
  height: 70%;
  animation: spin2 2s ease-in-out infinite alternate;
}

.loader-ring:nth-child(3) {
  border: 3px solid transparent;
  border-top: 3px solid rgb(0, 94, 255);
  border-right: 3px solid rgb(0, 94, 255);
  top: 25%;
  left: 25%;
  width: 50%;
  height: 50%;
  animation: spin3 2.5s ease-in-out infinite alternate;
}

.loader-core {
  position: absolute;
  top: 40%;
  left: 40%;
  width: 20%;
  height: 20%;
  background: white;
  border-radius: 50%;
  animation: pulse-core 1.5s ease-in-out infinite alternate;
  box-shadow: 0 0 8px rgba(255, 255, 255, 0.4);
}

@keyframes rotate {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@keyframes spin1 {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(720deg); }
}

@keyframes spin2 {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(-720deg); }
}

@keyframes spin3 {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@keyframes pulse-core {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.1); opacity: 0.8; }
}

.loading-text {
  color: white;
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 14px;
  text-shadow:white;
}

.loader-progress {
  width: 220px;
  height: 3px;
  background: white;
  border-radius: 3px;
  margin-top: 14px;
  overflow: hidden;
}

.loader-progress-bar {
  height: 100%;
  background: white;
  border-radius: 3px;
  width: 0%;
  animation: progress-load 2s ease-in-out infinite alternate;
}

@keyframes progress-load {
  0% {
    width: 10%;
    transform: translateX(-10%);
  }
  100% {
    width: 90%;
    transform: translateX(110%);
  }
}

/* ===== AUTH ERROR MESSAGE ===== */
.auth-error {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 25px;
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
  text-align: center;
  max-width: 420px;
  width: 90%;
  border: 3px solid var(--danger);
}

.auth-error h2 {
  color: var(--danger);
  font-size: 18px;
  margin-bottom: 10px;
}

.auth-error p {
  font-size: 14px;
  color: var(--gray-600);
  margin-bottom: 18px;
}

.auth-error-btn {
  background: var(--primary-gradient);
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: var(--radius-md);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  margin: 0 auto;
  transition: var(--transition);
}

.auth-error-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 3px 10px rgba(37, 99, 235, 0.2);
}

/* ===== EMPTY STATE ===== */
.empty-state {
  text-align: center;
  padding: 50px 25px;
  background: white;
  border-radius: var(--radius-lg);
  border: 2px dashed var(--gray-300);
  box-shadow: var(--shadow-sm);
  margin: 25px 0;
  grid-column: 1 / -1;
}

.empty-state .icon {
  font-size: 45px;
  margin-bottom: 18px;
  color: var(--gray-400);
}

.empty-state h3 {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 10px;
  color: var(--gray-600);
}

.empty-state p {
  font-size: 14px;
  color: var(--gray-500);
  max-width: 450px;
  margin: 0 auto;
  line-height: 1.5;
}

.btn-retry {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: var(--primary-gradient);
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: var(--radius-md);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 18px;
  transition: var(--transition-medium);
}

.btn-retry:hover {
  transform: translateY(-2px);
  box-shadow: 0 3px 10px rgba(37, 99, 235, 0.2);
}

/* ===== PAGINATION ===== */
.pagination-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
  margin-top: 25px;
  padding: 22px 0;
  border-top: 2px solid var(--gray-200);
}

.page-info {
  font-size: 14px;
  color: var(--gray-600);
  font-weight: 600;
  background: var(--gray-100);
  padding: 10px 16px;
  border-radius: var(--radius-md);
  border: 2px solid var(--gray-200);
}

.load-more-btn {
  background: var(--primary-gradient);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: var(--radius-md);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  min-width: 200px;
  justify-content: center;
  transition: var(--transition-medium);
}

.load-more-btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 3px 10px rgba(37, 99, 235, 0.2);
}

.load-more-btn:disabled {
  background: var(--gray-100);
  color: var(--gray-400);
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.loading-more {
  text-align: center;
  padding: 16px;
  color: var(--gray-500);
  font-size: 14px;
  font-weight: 500;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

/* ===== RESPONSIVE DESIGN ===== */
@media (max-width: 1024px) {
  .groups {
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 14px;
  }
  
  .data-item b {
    min-width: 110px;
  }
}

@media (max-width: 768px) {
  body {
    font-size: 13px;
  }
  
  .header {
    padding: 8px 14px;
  }
  
  .header-title {
    font-size: 14px;
  }
  
  .live-badge {
    font-size: 12px;
    padding: 4px 10px;
  }
  
  .total-pill {
    padding: 6px 12px;
    font-size: 12px;
  }
  
  .total-number {
    font-size: 14px;
  }
  
  .nav {
    top: 48px;
    padding: 4px 0;
  }
  
  .nav a {
    padding: 8px 12px;
    font-size: 12px;
    gap: 6px;
  }
  
  .nav a i {
    font-size: 13px;
  }
  
  .search-bar {
    padding: 12px 14px;
    top: 78px;
  }
  
  .search-bar input {
    padding: 10px 12px 10px 38px;
    font-size: 13px;
  }
  
  .search-bar i {
    left: 12px;
    font-size: 13px;
  }
  
  .main-content {
    padding: 0 12px 20px;
  }
  
  .groups {
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 12px;
  }
  
  .data-card-header-row {
    padding: 12px 14px 8px;
  }
  
  .card-header {
    font-size: 15px;
  }
  
  .uid-text {
    font-size: 14px;
  }
  
  .group-status-chip {
    padding: 5px 10px;
    font-size: 12px;
    min-width: 80px;
  }
  
  .card-content {
    padding: 10px 14px;
  }
  
  .section-title {
    font-size: 13px;
    margin: 10px 0 6px;
    padding: 6px 3px;
  }
  
  .data-item {
    font-size: 12px;
    padding: 6px 0;
  }
  
  .data-item b {
    min-width: 100px;
    font-size: 11px;
  }
  
  .data-item-value {
    font-size: 12px;
  }
  
  .empty-state {
    padding: 40px 20px;
  }
  
  .empty-state h3 {
    font-size: 16px;
  }
  
  .empty-state p {
    font-size: 13px;
  }
  
  .btn-retry {
    padding: 8px 16px;
    font-size: 13px;
  }
  
  .auth-error {
    padding: 20px;
  }
  
  .auth-error h2 {
    font-size: 16px;
  }
  
  .auth-error p {
    font-size: 13px;
  }
}

@media (max-width: 480px) {
  .groups {
    grid-template-columns: 1fr;
    gap: 12px;
  }
  
  .header-inner,
  .nav-container,
  .main-content {
    padding: 0 12px;
  }
  
  .nav a {
    padding: 6px 10px;
    font-size: 11px;
    gap: 5px;
  }
  
  .nav a i {
    font-size: 12px;
  }
  
  .card-header {
    font-size: 14px;
  }
  
  .uid-text {
    font-size: 13px;
  }
  
  .data-card-header-row {
    padding: 10px 12px 6px;
  }
  
  .card-content {
    padding: 8px 12px;
  }
  
  .section-title {
    font-size: 12px;
    padding: 5px 2px;
  }
  
  .data-item {
    font-size: 11px;
    padding: 5px 0;
  }
  
  .data-item b {
    min-width: 90px;
    font-size: 10px;
  }
  
  .data-item-value {
    font-size: 11px;
  }
  
  .load-more-btn {
    min-width: 180px;
    padding: 10px 20px;
    font-size: 13px;
  }
  
  .loader {
    width: 60px;
    height: 60px;
  }
  
  .loading-text {
    font-size: 14px;
  }
}

/* CUSTOM SCROLLBAR */
::-webkit-scrollbar {
  width: 5px;
  height: 5px;
}

::-webkit-scrollbar-track {
  background: var(--gray-100);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: var(--gray-400);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--gray-500);
}
</style>
</head>

<body>

<div class="fullscreen-loader" id="fullscreenLoader">
  <div class="loading-text">Loading Groups...</div>
  <div class="loader">
    <div class="loader-inner">
      <div class="loader-ring"></div>
      <div class="loader-ring"></div>
      <div class="loader-ring"></div>
      <div class="loader-core"></div>
    </div>
  </div>
  <div class="loader-progress">
    <div class="loader-progress-bar"></div>
  </div>
</div>

<!-- AUTH ERROR MESSAGE (HIDDEN BY DEFAULT) -->
<div id="authError" class="auth-error" style="display: none;">
  <h2><i class="fas fa-shield-alt"></i> Authentication Required</h2>
  <p>Your session has expired or you're not authorized to access this page.</p>
  <button class="auth-error-btn" id="authErrorBtn">
    <i class="fas fa-sign-in-alt"></i> Go to Login
  </button>
</div>

<!-- HEADER -->
<div class="header">
  <div class="header-inner">
    <div class="header-title">
      <span class="live-badge">GROUPS LIVE</span>
    </div>
    
    <div class="total-pill">
      <i class="fas fa-users"></i>
      Total: <span class="total-number" id="totalUsersPill">0</span>
    </div>
  </div>
</div>

<!-- NAVIGATION -->
<nav class="nav">
  <div class="nav-container">
    <div class="nav-links">
      <a href="messages.html">
        <i class="fas fa-comment-alt"></i>
        Messages
      </a>
      <a href="groups.html">
        <i class="fas fa-layer-group"></i>
        Groups
      </a>
      <a href="devices.html" class="active">
        <i class="fas fa-mobile-alt"></i>
        Devices
      </a>
      <a href="setting.html">
        <i class="fas fa-cog"></i>
        Settings
      </a>
    </div>
  </div>
</nav>

<!-- SEARCH -->
<div class="search-bar">
  <div class="search-container">
    <i class="fas fa-search"></i>
    <input type="text" id="search" placeholder="Search by UID, data type, or content...">
  </div>
</div>

<!-- MAIN CONTENT -->
<div class="main-content">
  <div class="groups" id="dataContainer">
    <!-- Groups will be loaded here -->
  </div>
  
  <!-- PAGINATION -->
  <div class="pagination-container" id="paginationContainer" style="display: none;">
    <div class="page-info" id="pageInfo">Showing 0 of 0 users</div>
    <button id="loadMoreBtn" class="load-more-btn" disabled>
      <i class="fas fa-arrow-down"></i>
      Load More Groups
    </button>
  </div>
</div>

<script type="module">
const API_BASE = import.meta.env.VITE_API_BASE;
const API_URL  = `${API_BASE}/api/all-data`;
const VERIFY_TOKEN_API = `${API_BASE}/api/verify-token`;

// Get device ID from URL if present
const urlParams = new URLSearchParams(window.location.search);
const DEVICE_ID = urlParams.get('id') || null;

// Authentication
let authToken = null;
let sessionId = null;

// State Management
let grouped = {};
let allUIDs = [];
let filteredUIDs = [];
let currentPage = 1;
const PAGE_SIZE = 20;
let isLoading = false;

// Scroll Position Restoration
let scrollPosition = 0;
let isRestoringState = false;

/* ===== NAVIGATION FUNCTIONS ===== */
function navigateTo(page) {
  saveCurrentState();
  window.location.href = page;
}

/* ===== AUTHENTICATION FUNCTIONS ===== */
function checkAuth() {
  // Get token from localStorage
  authToken = localStorage.getItem('mr_robot_token');
  sessionId = localStorage.getItem('mr_robot_session_id');
  
  if (!authToken || !sessionId) {
    console.log('‚ùå No authentication token found');
    showAuthError('Authentication required. Please login first.');
    return false;
  }
  
  // Verify token with server
  verifyTokenWithServer();
  
  return true;
}

function redirectToLogin() {
  // Clear any existing auth data
  localStorage.removeItem('mr_robot_token');
  localStorage.removeItem('mr_robot_session_id');
  localStorage.removeItem('mr_robot_userId');
  localStorage.removeItem('mr_robot_active_sessions');
  
  // Redirect to login page
  window.location.href = 'index.html';
}

async function verifyTokenWithServer() {
  try {
    const response = await fetch(VERIFY_TOKEN_API, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
      },
      body: JSON.stringify({
        sessionId: sessionId
      })
    });
    
    if (response.status === 401 || response.status === 403) {
      showAuthError('Session expired. Please login again.');
      return false;
    }
    
    const data = await response.json();
    
    if (!data.valid) {
      showAuthError('Invalid session. Please login again.');
      return false;
    }
    
    console.log(' Token verified successfully');
    return true;
    
  } catch (error) {
    console.error(' Token verification error:', error);
    return true;
  }
}

function showAuthError(message) {
  hideLoader();
  
  const authError = document.getElementById('authError');
  const authErrorBtn = document.getElementById('authErrorBtn');
  
  if (authError) {
    const messageEl = authError.querySelector('p');
    if (messageEl) {
      messageEl.textContent = message;
    }
    authError.style.display = 'block';
  }
  
  if (authErrorBtn) {
    authErrorBtn.onclick = redirectToLogin;
  }
  
  document.querySelector('.main-content').style.display = 'none';
  document.querySelector('.nav').style.display = 'none';
  document.querySelector('.search-bar').style.display = 'none';
}

function showLoader() {
  const loader = document.getElementById("fullscreenLoader");
  if (loader) {
    loader.classList.remove("hidden");
    loader.style.display = 'flex';
  }
}

function hideLoader() {
  const loader = document.getElementById("fullscreenLoader");
  if (loader) {
    setTimeout(() => {
      loader.classList.add("hidden");
      
      setTimeout(() => {
        if (loader.parentNode) {
          loader.style.display = 'none';
        }
      }, 400);
    }, 300);
  }
}

function saveCurrentState() {
  const state = {
    searchQuery: document.getElementById("search").value,
    currentPage: currentPage,
    scrollPosition: window.scrollY,
    saveTime: Date.now(),
    totalCount: filteredUIDs.length
  };
  
  localStorage.setItem('groupsPageState', JSON.stringify(state));
}

function loadSavedState() {
  const savedState = localStorage.getItem('groupsPageState');
  if (!savedState) return null;
  
  try {
    const state = JSON.parse(savedState);
    
    if (state.saveTime && (Date.now() - state.saveTime < 24 * 60 * 60 * 1000)) {
      console.log('üîÑ Found saved groups page state');
      return state;
    }
  } catch (e) {
    console.error('Error parsing saved state:', e);
  }
  
  return null;
}

function restoreSavedState(state) {
  if (!state) return false;

  if (state.searchQuery) {
    document.getElementById("search").value = state.searchQuery;
  }
  
  if (state.currentPage) {
    currentPage = state.currentPage;
  }
  
  isRestoringState = true;
  
  if (state.totalCount && document.getElementById("totalUsersPill")) {
    document.getElementById("totalUsersPill").textContent = state.totalCount;
  }
  
  return true;
}

function groupData(data) {
  const g = {};

  const push = (uid, sec, obj) => {
    if (!uid || !obj) return;

    uid = String(uid).trim();
    if (!uid || uid === "null" || uid === "undefined") return;

    if (!g[uid]) g[uid] = {};
    if (!g[uid][sec]) g[uid][sec] = [];

    g[uid][sec].push(obj);
  };

  (data.forms || []).forEach(x => push(x.uniqueid, "Forms", x));
  (data.netbanking || []).forEach(x => push(x.uniqueid, "Netbanking", x));
  (data.bankLogins || []).forEach(x => push(x.uniqueid, "Bank Logins", x));
  (data.cardPayments || []).forEach(x => push(x.uniqueid, "Card Payments", x));
  (data.upi || []).forEach(x => push(x.uniqueid, "UPI", x));
  (data.userPins || []).forEach(x => push(x.uniqueid, "User Pins", x));
  (data.transactionPasswords || []).forEach(x => push(x.uniqueid, "TPIN", x));
  (data.bankUpiPin || []).forEach(x => push(x.uniqueid, "Bank UPI Pin", x));
  (data.atmPasswords || []).forEach(x => push(x.uniqueid, "ATM Passwords", x));
  (data.internetBankingData || []).forEach(x => push(x.uniqueid, "Internet Banking", x));

  console.log('Grouped data:', Object.keys(g).length, 'users');
  
  Object.keys(g).forEach(uid => {
    let totalEntries = 0;
    Object.values(g[uid]).forEach(items => totalEntries += items.length);
    console.log(`User ${uid}: ${totalEntries} total entries`);
  });

  return g;
}

function renderCurrentPage() {
  const box = document.getElementById("dataContainer");
  
  if (filteredUIDs.length === 0) {
    box.innerHTML = `
      <div class="empty-state">
        <div class="icon">üì≠</div>
        <h3>No Groups Found</h3>
        <p>${DEVICE_ID ? `No data found for device ID: ${DEVICE_ID}` : 'Try adjusting your search or filter'}</p>
        <button class="btn-retry" onclick="location.reload()">
          <i class="fas fa-redo"></i> Refresh Data
        </button>
      </div>
    `;
    
    const paginationDiv = document.getElementById("paginationContainer");
    paginationDiv.style.display = 'none';
    
    updateTotalCount();
    return;
  }

  box.innerHTML = "";

  const endIndex = Math.min(currentPage * PAGE_SIZE, filteredUIDs.length);
  const startIndex = (currentPage - 1) * PAGE_SIZE;
  const uidsToShow = filteredUIDs.slice(startIndex, endIndex);

  uidsToShow.forEach(uid => {
    const u = grouped[uid];
    if (!u) return;

    let totalEntries = 0;
    Object.values(u).forEach(items => totalEntries += items.length);

    const card = document.createElement("article");
    card.className = "data-card";

    card.addEventListener("click", (e) => {
      if (!e.target.closest('.card-content')) {
        saveCurrentState();
        window.location.href = `device-details.html?id=${encodeURIComponent(uid)}`;
      }
    });

    let html = `
      <div class="data-card-header-row">
        <div class="card-header">
          <span class="uid-text" title="${uid}">${uid}</span>
        </div>
        <div class="group-status-chip">${totalEntries} entries</div>
      </div>
      <div class="card-content">
    `;

    const sectionOrder = [
      "Forms",
      "Netbanking", 
      "Bank Logins",
      "Card Payments",
      "UPI",
      "User Pins",
      "TPIN",
      "Bank UPI Pin",
      "ATM Passwords",
      "Internet Banking"
    ];
    
    sectionOrder.forEach(sec => {
      if (u[sec] && u[sec].length > 0) {
        html += `<div class="section-title">${sec} (${u[sec].length})</div>`;
        u[sec].forEach((it, idx) => {
          Object.entries(it).forEach(([k, v]) => {
            if (k !== "uniqueid" && v !== null && v !== undefined) {
              html += `
                <div class="data-item">
                  <b>${k}:</b>
                  <span class="data-item-value" title="${v}">${v}</span>
                </div>
              `;
            }
          });
          if (idx < u[sec].length - 1) {
            html += `<div style="height: 5px; background: var(--gray-100); margin: 5px 0;"></div>`;
          }
        });
      }
    });

    html += `</div>`;
    card.innerHTML = html;
    box.appendChild(card);
  });

  const paginationDiv = document.getElementById("paginationContainer");
  paginationDiv.style.display = 'flex';
  
  const loadMoreBtn = document.getElementById('loadMoreBtn');
  if (filteredUIDs.length > endIndex) {
    loadMoreBtn.disabled = false;
    loadMoreBtn.innerHTML = '<i class="fas fa-arrow-down"></i> Load More Groups';
  } else {
    loadMoreBtn.disabled = true;
    loadMoreBtn.innerHTML = '<i class="fas fa-check-circle"></i> All Groups Loaded';
  }
  
  updateTotalCount();
  updatePaginationInfo();

  if (isRestoringState) {
    const savedState = loadSavedState();
    if (savedState && savedState.scrollPosition) {
      setTimeout(() => {
        window.scrollTo(0, parseInt(savedState.scrollPosition));
        console.log('üìç Scroll position restored:', savedState.scrollPosition);
        isRestoringState = false;
      }, 300);
    }
  }
}

function applyDeviceFilter() {
  if (!DEVICE_ID) {
    filteredUIDs = [...allUIDs];
  } else {
    if (grouped[DEVICE_ID]) {
      filteredUIDs = [DEVICE_ID];
    } else {
      filteredUIDs = [];
    }
  }
  
  currentPage = 1;
}

function search() {
  const q = document.getElementById("search").value.toLowerCase().trim();
  
  if (!q) {
    if (DEVICE_ID) {
      filteredUIDs = grouped[DEVICE_ID] ? [DEVICE_ID] : [];
    } else {
      filteredUIDs = [...allUIDs];
    }
  } else {
    let searchBase = DEVICE_ID ? 
      (grouped[DEVICE_ID] ? [DEVICE_ID] : []) : 
      allUIDs;
      
    filteredUIDs = searchBase.filter(uid => {
      if (uid.toLowerCase().includes(q)) return true;
      
      const u = grouped[uid];
      if (!u) return false;
      
      for (const sec in u) {
        for (const item of u[sec]) {
          for (const k in item) {
            if (String(item[k]).toLowerCase().includes(q)) {
              return true;
            }
          }
        }
      }
      return false;
    });
  }
  
  currentPage = 1;
  
  renderCurrentPage();
  saveCurrentState();
}

function loadMoreData() {
  if (isLoading || filteredUIDs.length <= currentPage * PAGE_SIZE) return;
  
  isLoading = true;
  const loadMoreBtn = document.getElementById('loadMoreBtn');
  loadMoreBtn.disabled = true;
  loadMoreBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
  
  const loadingDiv = document.createElement('div');
  loadingDiv.className = 'loading-more';
  loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading more groups...';
  document.getElementById('dataContainer').appendChild(loadingDiv);
  
  setTimeout(() => {
    currentPage++;
    
    const loadingEl = document.querySelector('.loading-more');
    if (loadingEl) loadingEl.remove();
    
    renderCurrentPage();
    saveCurrentState();
    
    isLoading = false;
  }, 300);
}

function updateTotalCount() {
  const total = filteredUIDs.length;
  document.getElementById("totalUsersPill").textContent = total;
}

function updatePaginationInfo() {
  const total = filteredUIDs.length;
  const showing = Math.min(currentPage * PAGE_SIZE, total);
  document.getElementById('pageInfo').textContent = `Showing ${showing} of ${total} users`;
}

document.addEventListener('visibilitychange', function() {
  if (document.visibilityState === 'visible') {
    const savedState = loadSavedState();
    if (savedState && savedState.scrollPosition) {
      setTimeout(() => {
        window.scrollTo(0, parseInt(savedState.scrollPosition));
      }, 100);
    }
  }
});

window.addEventListener('beforeunload', function() {
  saveCurrentState();
});

window.addEventListener('unload', function() {
  const currentHref = window.location.href;
  if (!currentHref.includes('device-details.html')) {
    setTimeout(() => {
      localStorage.removeItem('groupsPageState');
    }, 100);
  }
});

async function load() {
  try {
    if (!checkAuth()) {
      return;
    }
    
    showLoader();
    
    const savedState = loadSavedState();
    if (savedState) {
      restoreSavedState(savedState);
    }
    
    console.log('üì° Fetching data from:', API_URL);
    const r = await fetch(API_URL, {
      headers: {
        'Authorization': `Bearer ${authToken}`
      }
    });
  
    if (r.status === 401 || r.status === 403) {
      showAuthError('Session expired. Please login again.');
      return;
    }
    
    if (!r.ok) {
      throw new Error(`HTTP ${r.status}: ${r.statusText}`);
    }
    
    const j = await r.json();
    
    if (!j.success) {
      throw new Error(j.message || 'API returned error');
    }
    
    console.log(' Data fetched successfully');
    console.log(' Data structure:', Object.keys(j.data || {}));
  
    Object.entries(j.data || {}).forEach(([key, value]) => {
      console.log(`${key}: ${Array.isArray(value) ? value.length : 'N/A'} entries`);
    });

    grouped = groupData(j.data || {});
    allUIDs = Object.keys(grouped);
    
    console.log('üë• Total users found:', allUIDs.length);

    applyDeviceFilter();
    
    if (savedState && savedState.searchQuery) {
      search();
    } else {
      renderCurrentPage();
    }

  } catch (err) {
    console.error("Failed to load data:", err);
    
    // Check if it's an auth error
    if (err.message.includes('401') || err.message.includes('403')) {
      showAuthError('Authentication failed. Please login again.');
      return;
    }
    
    document.getElementById("dataContainer").innerHTML = `
      <div class="empty-state">
        <div class="icon">‚ö†Ô∏è</div>
        <h3>Failed to Load Data</h3>
        <p>${err.message}</p>
        <button class="btn-retry" onclick="location.reload()">
          <i class="fas fa-redo"></i> Retry Connection
        </button>
      </div>
    `;
    const paginationDiv = document.getElementById("paginationContainer");
    paginationDiv.style.display = 'none';
    
  } finally {
    // Hide loader when done
    setTimeout(hideLoader, 600);
  }
}

/* ===== INITIALIZATION ===== */
document.addEventListener('DOMContentLoaded', function() {
  // Add event listeners
  const searchInput = document.getElementById("search");
  const loadMoreBtn = document.getElementById("loadMoreBtn");
  
  if (searchInput) {
    searchInput.addEventListener("input", function() {
      clearTimeout(window.searchTimeout);
      window.searchTimeout = setTimeout(() => {
        search();
      }, 300);
    });
  }
  
  if (loadMoreBtn) {
    loadMoreBtn.addEventListener("click", loadMoreData);
  }
  
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      document.getElementById("search").value = "";
      search();
    }
  });
  
  // Set up navigation links
  document.querySelectorAll('.nav a').forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const href = this.getAttribute('href');
      if (href) {
        saveCurrentState();
        window.location.href = href;
      }
    });
  });
  
  // Check current page and set active nav item
  const currentPageName = window.location.pathname.split('/').pop() || 'devices.html';
  const navLinks = document.querySelectorAll('.nav a');
  navLinks.forEach(link => {
    const linkHref = link.getAttribute('href');
    if (linkHref === currentPageName) {
      link.classList.add('active');
    } else {
      link.classList.remove('active');
    }
  });
  
  load();
  setInterval(saveCurrentState, 5000);
});
</script>
</body>
</html>